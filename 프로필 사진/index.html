<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
      #container {
        display: flex;
      }
      .imgbox {
        position: relative;
        width: 200px;
        height: 200px;
        border: 1px solid black;
        margin-right: 10px;
      }
      .imgbox img {
        max-width: 100%;
        max-height: 100%;
      }
      .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 20px;
        cursor: pointer;
      }
    </style>
    <title>hi</title>
  </head>
  <body>
  
  <form action="">
    <div id="container">
      <div id="imgbox1" class="imgbox">
        <img src="pin1.png">
        <span class="delete-btn" onclick="deleteImgBox('imgbox1')">X</span>
        <input type="hidden" name="imgbox1">
      </div>
      <div id="imgbox2" class="imgbox">
        <img src="pin2.png">
        <span class="delete-btn" onclick="deleteImgBox('imgbox2')">X</span>
        <input type="hidden" name="imgbox2">
      </div>
      <div id="imgbox3" class="imgbox">
        <img src="pin3.png">
        <span class="delete-btn" onclick="deleteImgBox('imgbox3')">X</span>
        <input type="hidden" name="imgbox3">
      </div>
      <!-- 추가적인 imgbox들을 여기에 작성 -->
    </div>
  </form>
  <div>
    <input type="file" id="fileInput" accept="image/*" multiple>
    <button onclick="addImgBox()">추가</button>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    $(document).ready(function() {
      $("#container").sortable({
        update: function(event, ui) {
          var imgboxes = $("#container .imgbox");
          imgboxes.each(function(index) {
            var imgbox = $(this);
            var img = imgbox.find("img");
            var newImgboxId = "imgbox" + (index + 1);
            imgbox.attr("id", newImgboxId);
            imgbox.find(".delete-btn").attr("onclick", "deleteImgBox('" + newImgboxId + "')");
            imgbox.find("input").attr("name", newImgboxId);
          });
        }
      });
    });
  
    var imgboxCount = container.getElementsByClassName("imgbox").length; // 이미지 박스 개수를 저장하는 변수

    function addImgBox() {
      var fileInput = document.getElementById("fileInput");
      var files = fileInput.files;
      if (files.length > 0) {
        var container = document.getElementById("container");
        var newImgBox = document.createElement("div");
        newImgBox.className = "imgbox";
        
        imgboxCount++; // 이미지 박스 개수 증가
        var newImgboxId = "imgbox" + imgboxCount; // 새로운 아이디 생성
        
        var newImage = document.createElement("img");
        newImage.src = URL.createObjectURL(files[0]);
        newImage.onload = function() {
          URL.revokeObjectURL(this.src);
        };
        newImgBox.appendChild(newImage);
        
        var deleteBtn = document.createElement("span");
        deleteBtn.className = "delete-btn";
        deleteBtn.textContent = "X";
        deleteBtn.onclick = function() {
          deleteImgBox(newImgboxId);
        };
        newImgBox.appendChild(deleteBtn);
        
        container.appendChild(newImgBox);
        newImgBox.id = newImgboxId; // 새로운 아이디 설정
        
        $(newImgBox).sortable({
          handle: ".imgbox"
        });

        // 추가한 이미지가 입력되어 있는 상태로 복사하여 붙임
        var clonedInput = fileInput.cloneNode(true);
        clonedInput.id = "fileInput-" + newImgboxId; // 고유한 id 부여
        clonedInput.name = newImgboxId;
        clonedInput.style.display = "none";
        newImgBox.appendChild(clonedInput);
        fileInput.value = ""; // 파일 입력 필드 초기화
      }
    }

    function deleteImgBox(imgboxId) {
      var imgbox = document.getElementById(imgboxId);
      if (imgbox) {
        imgbox.remove();
        // 이미지 박스가 삭제되면 아이디 재조정
        var container = document.getElementById("container");
        var imgboxes = container.getElementsByClassName("imgbox");
        for (var i = 0; i < imgboxes.length; i++) {
          var id = "imgbox" + (i + 1);
          imgboxes[i].id = id;
          imgboxes[i].querySelector(".delete-btn").onclick = function() {
            deleteImgBox(id);
          };
        }
        imgboxCount = imgboxCount - 1;
      }
    }
  </script>
  </body>
</html>